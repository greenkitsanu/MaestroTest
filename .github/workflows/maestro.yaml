name: Maestro E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  pages: write

env:
  APP_ID: com.maestro.reactnative

jobs:
  #‚îÄ‚îÄ‚îÄ Android Maestro Tests ‚îÄ‚îÄ‚îÄ
  maestro-android:
    name: Maestro Tests (Android)
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Expo prebuild (Android)
        run: npx expo prebuild --platform android --clean

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('android/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Build Android Release APK
        working-directory: android
        run: ./gradlew assembleRelease

      - name: Enable KVM group perms
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Install Maestro
        uses: dniHze/maestro-test-action@v1

      - name: Run Maestro tests (Android)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          arch: x86_64
          profile: pixel_7_pro
          force-avd-creation: false
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: |
            adb install android/app/build/outputs/apk/release/app-release.apk
            adb shell settings put global window_animation_scale 0.0
            adb shell settings put global transition_animation_scale 0.0
            adb shell settings put global animator_duration_scale 0.0
            rm -rf screenshots maestro-output-android.log || true
            mkdir -p screenshots
            maestro test .maestro/flow.yaml --format junit --output maestro-report-android.xml | tee maestro-output-android.log
            mv *.png screenshots/ || true

      - name: Upload Android test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-results-android
          path: |
            maestro-output-android.log
            maestro-report-android.xml
            screenshots/

  # ‚îÄ‚îÄ‚îÄ iOS Maestro Tests ‚îÄ‚îÄ‚îÄ
  maestro-ios:
    name: Maestro Tests (iOS)
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Expo prebuild (iOS)
        run: npx expo prebuild --platform ios --clean

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: ios/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install CocoaPods
        working-directory: ios
        run: pod install

      - name: Build iOS app for simulator (Release)
        working-directory: ios
        run: |
          xcodebuild \
            -workspace MaestroReactNative.xcworkspace \
            -scheme MaestroReactNative \
            -configuration Release \
            -sdk iphonesimulator \
            -destination 'generic/platform=iOS Simulator' \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            build

      - name: Ensure iOS Simulator Runtime
        run: |
          if ! xcrun simctl list runtimes available | grep -qi "iOS"; then
            echo "No iOS runtime found ‚Äî downloading..."
            xcodebuild -downloadPlatform iOS
          fi

      - name: Boot iOS Simulator & Install App
        run: |
          SIMULATOR_NAME="iPhone 16"

          DEVICE_ID=$(xcrun simctl list devices available \
            | grep "$SIMULATOR_NAME" \
            | head -1 \
            | grep -oE '[0-9A-F-]{36}') || true

          if [ -z "$DEVICE_ID" ]; then
            echo "No '$SIMULATOR_NAME' found ‚Äî creating one..."
            IOS_RUNTIME=$(xcrun simctl list runtimes available \
              | grep -i "iOS" | tail -1 \
              | grep -oE 'com\.apple\.CoreSimulator\.SimRuntime\.iOS-[0-9-]+')
            DEVICE_TYPE=$(xcrun simctl list devicetypes \
              | grep -i "iPhone" | tail -1 \
              | grep -oE 'com\.apple\.CoreSimulator\.SimDeviceType\.[^ )]+')
            DEVICE_ID=$(xcrun simctl create "$SIMULATOR_NAME" "$DEVICE_TYPE" "$IOS_RUNTIME")
            echo "Created simulator: $DEVICE_ID"
          fi

          xcrun simctl boot "$DEVICE_ID" || true

          echo "Waiting for simulator to boot..."
          ELAPSED=0
          while ! xcrun simctl list devices | grep "$DEVICE_ID" | grep -q "(Booted)"; do
            sleep 5; ELAPSED=$((ELAPSED + 5))
            [ "$ELAPSED" -ge 120 ] && echo "Boot timeout" && exit 1
            echo "  ... waiting (${ELAPSED}s)"
          done
          echo "‚úì Simulator booted"
          sleep 10

          xcrun simctl install "$DEVICE_ID" ios/build/Build/Products/Release-iphonesimulator/MaestroReactNative.app
          xcrun simctl launch "$DEVICE_ID" "${{ env.APP_ID }}"
          sleep 10
          echo "‚úì App installed and launched"

      - name: Install Maestro
        uses: dniHze/maestro-test-action@v1

      - name: üß™ Run Maestro Tests (iOS)
        env:
          MAESTRO_DRIVER_STARTUP_TIMEOUT: "120000"
        run: |
          rm -rf screenshots maestro-output-ios.log || true
          mkdir -p screenshots
          maestro test .maestro/flow.yaml --format junit --output maestro-report-ios.xml | tee maestro-output-ios.log
          mv *.png screenshots/ || true

      - name: Upload iOS test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-results-ios
          path: |
            maestro-output-ios.log
            maestro-report-ios.xml
            screenshots/

  # ‚îÄ‚îÄ‚îÄ Generate Combined Report & Deploy ‚îÄ‚îÄ‚îÄ
  generate-report:
    name: Generate HTML Report & Deploy
    runs-on: ubuntu-latest
    needs: [maestro-android, maestro-ios]
    if: always()

    steps:
      - name: Download Android results
        uses: actions/download-artifact@v4
        with:
          name: maestro-results-android
          path: results/android
        continue-on-error: true

      - name: Download iOS results
        uses: actions/download-artifact@v4
        with:
          name: maestro-results-ios
          path: results/ios
        continue-on-error: true

      - name: üìÑ Generate Pretty HTML Report
        run: |
          mkdir -p ./gh-pages/screenshots/android ./gh-pages/screenshots/ios
          cp results/android/screenshots/*.png ./gh-pages/screenshots/android/ 2>/dev/null || echo "No Android screenshots"
          cp results/ios/screenshots/*.png ./gh-pages/screenshots/ios/ 2>/dev/null || echo "No iOS screenshots"

          ANDROID_LOG="results/android/maestro-output-android.log"
          IOS_LOG="results/ios/maestro-output-ios.log"
          ANDROID_REPORT="results/android/maestro-report-android.xml"
          IOS_REPORT="results/ios/maestro-report-ios.xml"

          # ‚îÄ‚îÄ Helper: safe grep count ‚îÄ‚îÄ
          safe_count() {
            local pattern="$1" file="$2"
            if [ -f "$file" ]; then
              grep -c "$pattern" "$file" || true
            else
              echo 0
            fi
          }

          # ‚îÄ‚îÄ Helper: parse JUnit XML for counts ‚îÄ‚îÄ
          parse_junit() {
            local file="$1" attr="$2"
            if [ -f "$file" ]; then
              grep -oP "${attr}=\"\K[0-9]+" "$file" | head -1 || echo 0
            else
              echo 0
            fi
          }

          # ‚îÄ‚îÄ Stats (prefer JUnit XML, fallback to log grep) ‚îÄ‚îÄ
          if [ -f "$ANDROID_REPORT" ]; then
            android_total=$(parse_junit "$ANDROID_REPORT" "tests")
            android_failed=$(parse_junit "$ANDROID_REPORT" "failures")
            android_passed=$((android_total - android_failed))
          else
            android_passed=$(safe_count "COMPLETED" "$ANDROID_LOG")
            android_failed=$(safe_count "FAILED" "$ANDROID_LOG")
            android_total=$((android_passed + android_failed))
          fi
          android_pct=$(awk -v p="$android_passed" -v t="$android_total" 'BEGIN {printf "%.1f", (t==0 ? 0 : p*100/t)}')

          if [ -f "$IOS_REPORT" ]; then
            ios_total=$(parse_junit "$IOS_REPORT" "tests")
            ios_failed=$(parse_junit "$IOS_REPORT" "failures")
            ios_passed=$((ios_total - ios_failed))
          else
            ios_passed=$(safe_count "COMPLETED" "$IOS_LOG")
            ios_failed=$(safe_count "FAILED" "$IOS_LOG")
            ios_total=$((ios_passed + ios_failed))
          fi
          ios_pct=$(awk -v p="$ios_passed" -v t="$ios_total" 'BEGIN {printf "%.1f", (t==0 ? 0 : p*100/t)}')

          total_passed=$((android_passed + ios_passed))
          total_failed=$((android_failed + ios_failed))
          total_all=$((total_passed + total_failed))
          total_pct=$(awk -v p="$total_passed" -v t="$total_all" 'BEGIN {printf "%.1f", (t==0 ? 0 : p*100/t)}')

          # ‚îÄ‚îÄ Decorate log helper ‚îÄ‚îÄ
          decorate_log() {
            sed -e 's/Launch app/üöÄ &/' \
                -e 's/Assert that/üîç &/' \
                -e 's/Tap on/üëÜ &/' \
                -e 's/Input text/üìù &/' \
                -e 's/Wait for/‚è≥ &/' \
                -e 's/Take screenshot/üì∏ &/' \
                -e 's/COMPLETED/‚úÖ COMPLETED/' \
                -e 's/FAILED/‚ùå FAILED/' \
                -e 's/RUNNING/üèÉ RUNNING/' "$1"
          }

          cat > ./gh-pages/index.html <<'HTMLHEAD'
          <!DOCTYPE html>
          <html><head><meta charset="UTF-8"><title>Maestro Test Report</title>
          <style>
            * { box-sizing: border-box; }
            body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 2rem; background: #f5f5f5; color: #222; max-width: 1200px; margin: 0 auto; }
            h1 { font-size: 2.2rem; margin-bottom: 0.5rem; }
            h2 { margin-top: 2.5rem; font-size: 1.5rem; border-bottom: 2px solid #ddd; padding-bottom: 0.5rem; }
            h3 { margin-top: 1.5rem; font-size: 1.2rem; }
            table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
            table td, table th { border: 1px solid #ccc; padding: 0.6rem 0.8rem; text-align: left; }
            table th { background: #eee; width: 180px; }
            .summary-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-top: 1rem; }
            .summary-card { background: #fff; border: 1px solid #ddd; border-radius: 0.5rem; padding: 1.2rem; text-align: center; }
            .summary-card .number { font-size: 2rem; font-weight: bold; }
            .summary-card .label { color: #666; margin-top: 0.3rem; }
            .green { color: #16a34a; }
            .red { color: #dc2626; }
            .blue { color: #2563eb; }
            pre { background: #fff; padding: 1rem; border-radius: 0.5rem; white-space: pre-wrap; overflow-x: auto; font-size: 0.85rem; border: 1px solid #ddd; }
            .screenshots-grid {
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
              gap: 1.5rem;
              margin-top: 1rem;
            }
            .screenshot {
              background: #fff; border: 1px solid #ddd; border-radius: 0.5rem;
              padding: 0.8rem; box-shadow: 0 2px 4px rgba(0,0,0,0.06); text-align: center;
            }
            .screenshot img { border-radius: 0.5rem; max-width: 100%; height: auto; margin-top: 0.5rem; }
            .badge { display: inline-block; padding: 0.2rem 0.6rem; border-radius: 1rem; font-size: 0.8rem; font-weight: 600; }
            .badge-android { background: #d1fae5; color: #065f46; }
            .badge-ios { background: #dbeafe; color: #1e40af; }
          </style></head><body>
          HTMLHEAD

          cat >> ./gh-pages/index.html <<SUMMARY
          <h1>üìä Maestro E2E Test Report</h1>
          <p>Combined results from Android & iOS test runs.</p>

          <div class="summary-grid">
            <div class="summary-card">
              <div class="number green">${total_passed}</div>
              <div class="label">Tests Passed</div>
            </div>
            <div class="summary-card">
              <div class="number red">${total_failed}</div>
              <div class="label">Tests Failed</div>
            </div>
            <div class="summary-card">
              <div class="number blue">${total_pct}%</div>
              <div class="label">Success Rate</div>
            </div>
          </div>

          <h2>üì± Platform Results</h2>
          <table>
            <tr><th>Platform</th><th>Passed</th><th>Failed</th><th>Total</th><th>Success Rate</th></tr>
            <tr><td><span class="badge badge-android">Android</span></td><td>${android_passed}</td><td>${android_failed}</td><td>${android_total}</td><td>${android_pct}%</td></tr>
            <tr><td><span class="badge badge-ios">iOS</span></td><td>${ios_passed}</td><td>${ios_failed}</td><td>${ios_total}</td><td>${ios_pct}%</td></tr>
          </table>
          SUMMARY

          # ‚îÄ‚îÄ Android test log ‚îÄ‚îÄ
          echo '<h2>ü§ñ Android Test Log</h2>' >> ./gh-pages/index.html
          if [ -f "$ANDROID_LOG" ]; then
            echo '<pre>' >> ./gh-pages/index.html
            decorate_log "$ANDROID_LOG" >> ./gh-pages/index.html
            echo '</pre>' >> ./gh-pages/index.html
          else
            echo '<p>No Android log available.</p>' >> ./gh-pages/index.html
          fi

          # ‚îÄ‚îÄ iOS test log ‚îÄ‚îÄ
          echo '<h2>üçé iOS Test Log</h2>' >> ./gh-pages/index.html
          if [ -f "$IOS_LOG" ]; then
            echo '<pre>' >> ./gh-pages/index.html
            decorate_log "$IOS_LOG" >> ./gh-pages/index.html
            echo '</pre>' >> ./gh-pages/index.html
          else
            echo '<p>No iOS log available.</p>' >> ./gh-pages/index.html
          fi

          # ‚îÄ‚îÄ Android screenshots ‚îÄ‚îÄ
          echo '<h2>üñºÔ∏è Android Screenshots</h2><div class="screenshots-grid">' >> ./gh-pages/index.html
          for img in ./gh-pages/screenshots/android/*.png; do
            [ -f "$img" ] || continue
            base=$(basename "$img" .png)
            echo "<div class='screenshot'><strong>üîπ $base</strong><img src='screenshots/android/$base.png'/></div>" >> ./gh-pages/index.html
          done
          echo '</div>' >> ./gh-pages/index.html

          # ‚îÄ‚îÄ iOS screenshots ‚îÄ‚îÄ
          echo '<h2>üñºÔ∏è iOS Screenshots</h2><div class="screenshots-grid">' >> ./gh-pages/index.html
          for img in ./gh-pages/screenshots/ios/*.png; do
            [ -f "$img" ] || continue
            base=$(basename "$img" .png)
            echo "<div class='screenshot'><strong>üîπ $base</strong><img src='screenshots/ios/$base.png'/></div>" >> ./gh-pages/index.html
          done
          echo '</div>' >> ./gh-pages/index.html

          echo '</body></html>' >> ./gh-pages/index.html
          echo "‚úì Report generated at ./gh-pages/index.html"

      - name: üì§ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages
